// ============================================
// Prisma Schema para PostgreSQL (Produccion)
// ============================================
// Para usar este schema:
// 1. Copia este contenido a schema.prisma
// 2. Configura DATABASE_URL en .env.production
// 3. Ejecuta: npx prisma migrate deploy

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Multi-tenancy: Cada cliente tiene su tenant
model Tenant {
  id              String         @id @default(cuid())
  name            String
  email           String         @unique
  stripeCustomerId String?       @unique
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  users           User[]
  tradingAccounts TradingAccount[]
  signals         Signal[]
  positions       Position[]
  subscriptions   Subscription[]
  backtests       Backtest[]
  simulatedTrades  SimulatedTrade[]
  strategies       Strategy[]

  // Bot Operativa
  botConfigs      BotConfig[]
  trades          Trade[]

  // Marketplace
  publishedStrategies PublishedStrategy[]

  @@index([email])
}

model User {
  id             String    @id @default(cuid())
  tenantId       String
  tenant         Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  email          String    @unique
  name           String?
  emailVerified  DateTime?
  image          String?
  password       String    // Hashed con bcrypt
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  accounts         Account[]
  sessions         Session[]
  tradingAccounts  TradingAccount[]
  publishedStrategies PublishedStrategy[]
  strategyLikes    StrategyLike[]
  strategyComments StrategyComment[]

  @@index([email])
  @@index([tenantId])
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expires      DateTime

  @@index([userId])
  @@index([sessionToken])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model TradingAccount {
  id                  String   @id @default(cuid())
  tenantId            String
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  userId              String?
  user                User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  broker              String              // "VT Markets", "Infinox", etc.
  accountNumber       String
  platform            String              // "MT4", "MT5"
  server              String?
  encryptedApiKey     String              // Encriptado
  encryptedApiSecret  String?             // Encriptado
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  positions           Position[]

  @@index([tenantId])
  @@index([userId])
}

model Signal {
  id              String   @id @default(cuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  botConfigId     String?
  botConfig       BotConfig? @relation(fields: [botConfigId], references: [id], onDelete: SetNull)

  // Senal original de Telegram
  side            String              // "BUY", "SELL"
  price           Double?
  symbol          String              // "XAUUSD"
  messageText     String
  receivedAt      DateTime @default(now())

  // Origen (Telegram)
  channelId       String?
  channelName     String?
  messageId       String?

  // Estado de procesamiento
  status          String              @default("PENDING") // "PENDING", "PROCESSING", "EXECUTED", "FAILED", "CANCELLED"
  processedAt     DateTime?

  // Tipo especial
  isCloseSignal   Boolean @default(false) // "cerramos rango"

  // Restricciones del canal
  restrictionType String?             // "RIESGO", "SIN_PROMEDIOS", "SOLO_1_PROMEDIO", null
  maxLevels       Int                 @default(4)

  // Resultados
  positions       Position[]
  trades          Trade[]
  errorMessage    String?

  createdAt       DateTime  @default(now())

  @@index([tenantId, receivedAt])
  @@index([botConfigId, status])
}

model Position {
  id              String   @id @default(cuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  signalId        String?
  signal          Signal?  @relation(fields: [signalId], references: [id], onDelete: SetNull)
  tradingAccountId String?
  tradingAccount   TradingAccount? @relation(fields: [tradingAccountId], references: [id], onDelete: SetNull)

  side            String              // "BUY", "SELL"
  symbol          String              // "XAUUSD"
  lotSize         Double
  openPrice       Double
  closePrice      Double?
  stopLoss        Double?
  takeProfit      Double?

  // Estado
  status          String              @default("OPEN") // "OPEN", "CLOSED", "PENDING"
  openedAt        DateTime  @default(now())
  closedAt        DateTime?

  // Resultado
  profitPips      Double?
  profitMoney     Double?

  // Grid levels
  level           Int                 @default(0) // 0=base, 1=primer promedio, etc.

  createdAt       DateTime  @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId])
  @@index([signalId])
}

model Subscription {
  id              String   @id @default(cuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  stripePriceId    String?
  stripeSubId      String?   @unique
  status          String              // "ACTIVE", "CANCELED", "PAST_DUE"

  currentPeriodStart DateTime?
  currentPeriodEnd   DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId])
}

// Backtesting System
model Backtest {
  id                String   @id @default(cuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  name              String?             // Nombre personalizado del backtest
  strategyName      String              // "Toni G4", "Xisco G2", "Custom"
  status            String              @default("PENDING") // "PENDING", "RUNNING", "COMPLETED", "ERROR"

  // Parametros de configuracion (JSON)
  parameters        Json                // { lotaje, pipsDistance, maxLevels, takeProfit, stopLoss, useStopLoss, restrictionType }

  // Resultados
  totalTrades       Int                 @default(0)
  totalProfit       Double              @default(0)
  totalProfitPips   Double              @default(0)
  winRate          Double               @default(0)
  maxDrawdown       Double              @default(0)
  profitFactor      Double              @default(0)

  // Control de ejecucion
  startedAt         DateTime?
  completedAt       DateTime?
  error            String?

  // Tiempo de simulacion
  ticksProcessed    Int                 @default(0)
  totalTicks        Int                 @default(0)

  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt

  trades           SimulatedTrade[]

  @@index([tenantId])
  @@index([status])
}

model SimulatedTrade {
  id              String   @id @default(cuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  backtestId      String
  backtest        Backtest  @relation(fields: [backtestId], references: [id], onDelete: Cascade)

  // Referencia a senal original (si existe)
  signalIndex     Int                 // Indice en el CSV de senales

  // Tipo de evento
  type            String              // "OPEN", "AVERAGE", "CLOSE", "TAKE_PROFIT", "STOP_LOSS"

  // Datos de la operacion
  side            String              // "BUY", "SELL"
  price           Double
  lotSize         Double
  level           Int                 @default(0) // 0=base, 1=primer promedio, etc.

  // Resultado
  profit          Double
  profitPips      Double

  // Timestamp de cuando ocurrio (simulado)
  timestamp       DateTime

  createdAt       DateTime             @default(now())

  @@index([backtestId])
  @@index([tenantId])
}

// ============================================
// TICKS CACHE - Datos historicos para backtesting
// ============================================
// IMPORTANTE: Esta tabla puede tener 70M+ registros
// Considera particionamiento o almacenamiento alternativo para produccion

model TickData {
  id        BigInt   @id @default(autoincrement())

  // Simbolo del activo
  symbol    String              // "XAUUSD"

  // Timestamp del tick
  timestamp DateTime            // UTC

  // Precios
  bid       Double
  ask       Double
  spread    Double

  // Indices para consultas rapidas
  @@index([symbol, timestamp])
  @@index([timestamp])
}

// ============================================
// STRATEGIES - Estrategias guardadas por el usuario
// ============================================

model Strategy {
  id              String   @id @default(cuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Nombre descriptivo
  name            String              // "Mi estrategia conservadora"
  description     String?             // Descripcion opcional

  // Parametros de configuracion
  strategyName    String              @default("Custom") // "Toni G4", "Xisco G2", "Custom"
  lotajeBase      Double              @default(0.1)
  numOrders       Int                 @default(1)
  pipsDistance    Int                 @default(10)
  maxLevels       Int                 @default(4)
  takeProfitPips  Int                 @default(20)
  stopLossPips    Int?
  useStopLoss     Boolean             @default(false)
  useTrailingSL   Boolean             @default(true)
  trailingSLPercent Int              @default(50)
  restrictionType String?             // "RIESGO", "SIN_PROMEDIOS", "SOLO_1_PROMEDIO"

  // Resultados del ultimo backtest (para referencia)
  lastTotalTrades Int?
  lastTotalProfit Double?
  lastWinRate     Double?
  lastMaxDrawdown Double?
  lastTestedAt    DateTime?

  // Metadatos
  isFavorite      Boolean             @default(false)
  isActive        Boolean             @default(true)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([tenantId])
}

// ============================================
// PUBLISHED STRATEGIES - Marketplace de operativas
// ============================================

model PublishedStrategy {
  id              String   @id @default(cuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Autor (quien publico)
  authorId        String
  author          User    @relation(fields: [authorId], references: [id], onDelete: Cascade)

  // Estrategia original (opcional, si es fork)
  parentStrategyId String?
  parentStrategy PublishedStrategy? @relation("StrategyForks", fields: [parentStrategyId], references: [id], onDelete: SetNull)
  forks            PublishedStrategy[] @relation("StrategyForks")

  // Informacion basica
  name            String
  description     String?
  version         Int      @default(1)

  // Parametros de configuracion (copiados de Strategy)
  strategyName    String              @default("Custom")
  lotajeBase      Double              @default(0.1)
  numOrders       Int                 @default(1)
  pipsDistance    Int                 @default(10)
  maxLevels       Int                 @default(4)
  takeProfitPips  Int                 @default(20)
  stopLossPips    Int?
  useStopLoss     Boolean             @default(false)
  useTrailingSL   Boolean             @default(true)
  trailingSLPercent Int              @default(50)
  restrictionType String?             // "RIESGO", "SIN_PROMEDIOS", "SOLO_1_PROMEDIO"

  // Resultados del backtest (snapshot al publicacion)
  totalTrades     Int      @default(0)
  totalProfit     Double   @default(0)
  winRate         Double   @default(0)
  maxDrawdown     Double   @default(0)
  profitFactor    Double   @default(0)

  // Metricas sociales
  likesCount      Int      @default(0)
  forksCount     Int      @default(0)
  downloadsCount Int      @default(0)

  // Categorizacion
  tags            Json?    // Array de strings serializado: ["tag1", "tag2"]
  isPublic        Boolean @default(true)

  // Timestamps
  publishedAt     DateTime @default(now())
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relaciones sociales
  likes           StrategyLike[]
  comments        StrategyComment[]

  @@index([tenantId])
  @@index([authorId])
  @@index([parentStrategyId])
  @@index([isPublic])
}

// ============================================
// BOT CONFIGURATION - Configuracion del bot por tenant
// ============================================

model BotConfig {
  id              String   @id @default(cuid())
  tenantId        String   @unique
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // API Key para autenticacion del bot (hasheada con bcrypt)
  apiKeyHash      String

  // Estado del bot
  status          String   @default("OFFLINE") // "OFFLINE", "ONLINE", "ERROR", "PAUSED"

  // Configuracion de Telegram (encriptada)
  telegramApiIdEnc     String?
  telegramApiHashEnc   String?
  telegramSessionEnc   String?
  telegramChannels     Json?    // [{id, accessHash}]

  // Configuracion de trading
  symbol          String   @default("XAUUSD")
  magicNumber     Int      @default(20250101)

  // Parametros de entrada (entry)
  entryLot        Double   @default(0.1)
  entryNumOrders  Int      @default(1)
  entryTrailingActivate Int?    // pips para activar trailing
  entryTrailingStep     Int?    // pips step del trailing
  entryTrailingBack     Int?    // pips de retroceso
  entryTrailingBuffer   Int?    // buffer en pips

  // Parametros de promedios (grid)
  gridStepPips    Int      @default(10)
  gridLot         Double   @default(0.1)
  gridMaxLevels   Int      @default(4)
  gridNumOrders   Int      @default(1)
  gridTolerancePips Int    @default(1)

  // Restricciones
  restrictionType String?  // "RIESGO", "SIN_PROMEDIOS", "SOLO_1_PROMEDIO"
  maxLevels       Int      @default(4)

  // Timestamps
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relaciones
  heartbeats      BotHeartbeat[]
  signals         Signal[]
  trades          Trade[]
  botAccounts     BotAccount[]

  @@index([tenantId])
  @@index([apiKeyHash])
}

// ============================================
// BOT ACCOUNT - Cuentas MT5 asociadas al bot
// ============================================

model BotAccount {
  id              String   @id @default(cuid())
  botConfigId     String
  botConfig       BotConfig @relation(fields: [botConfigId], references: [id], onDelete: Cascade)

  // Credenciales MT5 (encriptadas con AES-256-GCM)
  loginEnc        String
  passwordEnc     String
  serverEnc       String
  pathEnc         String?

  // Configuracion especifica de la cuenta
  symbol          String   @default("XAUUSD")
  magic           Int

  // Estado
  isActive        Boolean  @default(true)
  lastSyncAt      DateTime?

  // Metricas ultimas del heartbeat
  lastBalance     Double?
  lastEquity      Double?
  lastMargin      Double?

  // Relaciones
  trades          Trade[]
  positions       BotPosition[]

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([botConfigId])
}

// ============================================
// BOT HEARTBEAT - Heartbeats del bot
// ============================================

model BotHeartbeat {
  id              String   @id @default(cuid())
  botConfigId     String
  botConfig       BotConfig @relation(fields: [botConfigId], references: [id], onDelete: Cascade)

  // Informacion del heartbeat
  timestamp       DateTime @default(now())
  version         String?  // Version del bot
  uptimeSeconds   Int?
  mt5Connected    Boolean  @default(false)
  telegramConnected Boolean @default(false)

  // Estado de posiciones
  openPositions   Int      @default(0)
  pendingOrders   Int      @default(0)

  // Metricas
  memoryMB        Double?
  cpuPercent      Double?

  // Error (si lo hay)
  errorMessage    String?

  @@index([botConfigId, timestamp])
}

// ============================================
// TRADE - Operaciones ejecutadas por el bot
// ============================================

model Trade {
  id              String   @id @default(cuid())
  tenantId        String
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  botConfigId     String?
  botConfig       BotConfig? @relation(fields: [botConfigId], references: [id], onDelete: SetNull)
  botAccountId    String?
  botAccount      BotAccount? @relation(fields: [botAccountId], references: [id], onDelete: SetNull)
  signalId        String?
  signal          Signal?  @relation(fields: [signalId], references: [id], onDelete: SetNull)

  // Datos del trade
  side            String              // "BUY", "SELL"
  symbol          String
  level           Int     @default(0) // 0=entrada, 1+=promedio

  // Apertura
  mt5Ticket       Int?                // Ticket en MT5
  openPrice       Double
  lotSize         Double
  openedAt        DateTime @default(now())

  // Cierre
  closePrice      Double?
  closedAt        DateTime?
  closeReason     String?             // "TAKE_PROFIT", "STOP_LOSS", "MANUAL", "GRID_STEP", "VIRTUAL_SL"

  // SL/TP
  stopLoss        Double?
  takeProfit      Double?
  virtualSL       Double?              // Trailing SL virtual

  // Resultado
  profitPips      Double?
  profitMoney     Double?
  commission      Double?
  swap            Double?

  // Estado
  status          String  @default("OPEN") // "PENDING", "OPEN", "CLOSED", "FAILED"

  // Error
  errorMessage    String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenantId, openedAt])
  @@index([botConfigId, status])
  @@index([signalId])
}

// ============================================
// BOT POSITION - Posiciones actuales del bot en vivo
// ============================================

model BotPosition {
  id              String   @id @default(cuid())
  botAccountId    String
  botAccount      BotAccount @relation(fields: [botAccountId], references: [id], onDelete: Cascade)
  tradeId         String?  @unique

  // Datos de la posicion
  mt5Ticket       Int
  symbol          String
  side            String
  level           Int      @default(0)

  // Estado actual
  openPrice       Double
  currentPrice    Double?
  lotSize         Double
  stopLoss        Double?
  takeProfit      Double?
  virtualSL       Double?

  // P&L no realizado
  unrealizedPL    Double?
  unrealizedPips  Double?

  // Timestamps
  openedAt        DateTime
  lastSyncAt      DateTime @default(now())

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([botAccountId, mt5Ticket])
  @@index([botAccountId])
}

// ============================================
// STRATEGY LIKE - Likes de usuarios a estrategias publicadas
// ============================================

model StrategyLike {
  id                  String   @id @default(cuid())
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  publishedStrategyId String
  publishedStrategy   PublishedStrategy @relation(fields: [publishedStrategyId], references: [id], onDelete: Cascade)

  createdAt           DateTime @default(now())

  @@unique([userId, publishedStrategyId])
  @@index([publishedStrategyId])
}

// ============================================
// STRATEGY COMMENT - Comentarios en estrategias publicadas
// ============================================

model StrategyComment {
  id                  String   @id @default(cuid())
  userId              String
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  publishedStrategyId String
  publishedStrategy   PublishedStrategy @relation(fields: [publishedStrategyId], references: [id], onDelete: Cascade)

  content             String

  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@index([publishedStrategyId])
}
